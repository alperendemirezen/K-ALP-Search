<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Kafka Search UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
    body {
      background-color: #f0f2f5;
      padding: 2rem;
      font-family: "Segoe UI", sans-serif;
    }
    .section {
  background: #ffffff;
  border-radius: 1rem;
  padding: 1rem 1.5rem; /* Ã¼st-alt 1rem, saÄŸ-sol 1.5rem */
  margin-bottom: 1.25rem;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}
    .form-control, .form-select {
      border-radius: 0.6rem;
    }
    .btn-primary {
      background: linear-gradient(to right, #4e73df, #1cc88a);
      border: none;
      font-weight: 500;
    }
    .btn-success {
      background-color: #1cc88a;
      border: none;
      font-weight: 500;
    }
    .layout-split {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .left-pane, .right-pane {
      flex: 1 1 400px;
      min-width: 300px;
    }
    #filtersContainer {
      margin-top: 1rem;
    }
    .vertical-divider {
  width: 1px;
  background-color: #ccc;
  margin: 0 0.5rem;
}
#modExplanation {
  background-color: #fefefe;
  border-left: 4px solid #1cc88a;
  padding: 1.2rem;
  font-size: 0.95rem;
}
.result-tab {
  display: inline-block;
  margin: 0 0.5rem 0.5rem 0;
  padding: 0.4rem 1rem;
  border-radius: 20px;
  background: #e2e6ea;
  color: #333;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.3s ease;
  position: relative;
}

.result-tab.active {
  background-color: #5a5c69;
  color: white;
}

.close-x {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #c82333;
  color: white;
  border-radius: 50%;
  font-size: 0.8rem;
  width: 20px;
  height: 20px;
  text-align: center;
  line-height: 20px;
  cursor: pointer;
}

.record-entry {
  background-color: #ffffff;
  border: 1px solid #dee2e6;
  padding: 1rem;
  margin-top: 0.5rem;
  border-radius: 0.6rem;
  font-family: monospace;
  white-space: pre-wrap;
  word-break: break-word;
}

.filter-summary {
  font-size: 0.9rem;
  color: #555;
  margin-bottom: 0.4rem;
  position: relative;
  padding-right: 8rem;
}

.autocomplete-box {
  position: absolute;
  background-color: #ffffff;
  border-radius: 0.5rem;
  margin-top: 0.25rem;
  max-height: 200px;
  overflow-y: auto;
  z-index: 1000;
   width: inherit;
  min-width: 0;
  box-sizing: border-box;
  font-size: 0.95rem;
}

.autocomplete-box div {
  padding: 0.5rem 1rem;
  cursor: pointer;
  border-bottom: 1px solid #f1f1f1;
}

.autocomplete-box div:last-child {
  border-bottom: none;
}

.autocomplete-box div:hover {
  background-color: #4e73df;
  color: white;
}
</style>
</head>
<body>
<div class="container">
    <h1 class="mb-4">ðŸ”Ž K-Search</h1>

    <div class="layout-split">
        <!-- LEFT SIDE -->
        <div class="left-pane">
            <div class="section">
                <label for="kafkaAddress" class="form-label">Kafka Address (IP:PORT)</label>
                <input type="text" id="kafkaAddress" class="form-control" placeholder="e.g., 127.0.0.1:9092">
                <button onclick="loadTopics()" class="btn btn-success mt-2">Load Topics</button>
            </div>

            <div class="section" id="topicSection" style="display: none;">
                <label for="topicSelect" class="form-label">Kafka Topic</label>
                <input type="text" id="topicSelect" class="form-control" placeholder="Search or select topic..."
                       oninput="filterTopics()" onfocus="showAllTopics()" autocomplete="off">
                <div id="autocompleteBox" class="autocomplete-box"></div>
            </div>

            <div class="section" id="searchOptions" style="display: none;">
                <label for="searchMode" class="form-label">Mode</label>
                <select id="searchMode" class="form-select">
                    <option value="all">all</option>
                    <option value="last">last</option>
                    <option value="date">date</option>
                    <option value="lastN">lastN</option>
                    <option value="manual">manual</option>
                    <option value="copy">copy</option>
                </select>
            </div>
        </div>

        <div class="vertical-divider"></div>
        <!-- RIGHT SIDE -->
        <div class="right-pane">
            <div id="modExplanation" class="section text-muted" style="display: none;">
                <strong>Mode Explanation:</strong>
                <p id="modExplanationText">SeÃ§ilen mod hakkÄ±nda bilgi burada gÃ¶rÃ¼necek.</p>
            </div>
            <div id="rightInfoMessage" class="section text-muted text-center">
                <p><em>The input fields for the selected mode will be displayed here.</em></p>
            </div>
            <div id="dateContainer" class="section" style="display: none;">
                <div><strong>Topic Partitions:</strong> <span id="datePartitions">Loading...</span></div>
                <label for="dateKey" class="form-label mt-2">Date Field Key (e.g. date)</label>
                <input type="text" id="dateKey" class="form-control" placeholder="Key to check (e.g., date)">

                <label for="targetDate" class="form-label mt-2">Target Date</label>
                <input type="text" id="targetDate" class="form-control" placeholder="Format: YYYYMMDD">

                <label for="partitionInputFirst" class="form-label mt-2">Partition</label>
                <input type="number" id="partitionInputFirst" class="form-control" value="0" min="0">
            </div>

            <div id="lastNContainer" class="section" style="display: none;">
                <label for="lastNCount" class="form-label">How many messages back do you want to scan?</label>
                <input type="number" id="lastNCount" class="form-control" min="1">
            </div>

            <div id="manualContainer" class="section" style="display: none;">
                <div><strong>Offset Range:</strong> Min: <span id="minOffset">?</span>, Max: <span id="maxOffset">?</span></div>
                <label for="startOffset" class="form-label mt-2">Start Offset</label>
                <input type="number" id="startOffset" class="form-control">
                <label for="endOffset" class="form-label mt-2">End Offset</label>
                <input type="number" id="endOffset" class="form-control">
            </div>

            <div id="copyContainer" class="section" style="display: none;">
                <div><strong>Offset Range:</strong> Min: <span id="copyMinOffset">?</span>, Max: <span id="copyMaxOffset">?</span></div>
                <div><strong>Partitions:</strong> <span id="partitionList">Loading...</span></div>
                <label for="copyStartOffset" class="form-label mt-2">Start Offset</label>
                <input type="number" id="copyStartOffset" class="form-control">
                <label for="copyEndOffset" class="form-label mt-2">End Offset</label>
                <input type="number" id="copyEndOffset" class="form-control">
                <label for="partitionInput" class="form-label mt-2">Partition</label>
                <input type="number" id="partitionInput" class="form-control" value="0" min="0">
                <label for="targetKafka" class="form-label mt-2">Target Kafka Address</label>
                <input type="text" id="targetKafka" class="form-control">
                <label for="targetTopic" class="form-label mt-2">Target Topic</label>
                <input type="text" id="targetTopic" class="form-control">
            </div>
        </div>
    </div>

    <!-- Filter Section (full-width) -->


    <div class="section" id="filtersContainer" style="display: none;">
        <div id="filterModeContainer" class="mb-2 d-flex align-items-center flex-wrap small">
            <label class="me-2 mb-1"><strong>Filter Mode:</strong></label>
            <div class="form-check form-check-inline mb-1">
                <input class="form-check-input" type="radio" name="modeType" id="stringMode" value="string" checked onchange="onFilterModeChange()">
                <label class="form-check-label" for="stringMode">String</label>
            </div>
            <div class="form-check form-check-inline mb-1">
                <input class="form-check-input" type="radio" name="modeType" id="jsonMode" value="json" onchange="onFilterModeChange()">
                <label class="form-check-label" for="jsonMode">JSON</label>
            </div>
            <div class="form-check form-check-inline mb-1">
                <input class="form-check-input" type="radio" name="modeType" id="patternMode" value="pattern" onchange="onFilterModeChange()">
                <label class="form-check-label" for="patternMode">Pattern</label>
            </div>
        </div>
        <div id="dynamicFilters"></div>
        <button class="btn btn-sm btn-outline-success mt-2" onclick="addFilter()">+ Add Filter</button>
    </div>

    <div id="finalSearch" class="mb-3" style="display: none;">
        <button id="searchButton" onclick="searchKafka()" class="btn btn-success">Search Kafka</button>
    </div>

    <div class="section">
        <h5>Results:</h5>
        <div id="resultTabs"></div>
        <div id="resultBoxes"></div>
    </div>
</div>



<script>

const modeExplanations = {
  all: "Scans all records based on the applied filters.",
  last: "Retrieves the latest record that matches the given filters.",
  lastN: "Scans the last X records from the end offset, where X is user-defined.",
  date: "Retrieves the first record matching the specified date.",
  manual: "Scans all records between the specified start and end offsets.",
copy: "Copies filtered records to another Kafka topic."};

  let searchCount = 0;
let activeTabId = null;
const abortControllers = {};
let filterMode = "string";

function loadTopics() {
  const kafkaAddress = document.getElementById("kafkaAddress").value.trim();
  if (!kafkaAddress) return alert("Kafka address is required");

  fetch(`http://localhost:7070/search/topics?kafkaAddress=${encodeURIComponent(kafkaAddress)}`)
    .then(res => res.json())
    .then(data => {
      allTopics = data.sort((a, b) => a.localeCompare(b)); // sadece autocomplete iÃ§in dizi

      document.getElementById("topicSection").style.display = "block";
    })
    .catch(() => alert("Failed to load topics."));
}

function topicSelected() {
  const topic = document.getElementById("topicSelect").value.trim();
  if (!topic) return;

  document.getElementById("searchOptions").style.display = "block";
  document.getElementById("filterModeContainer").style.display = "block";
  document.getElementById("rightInfoMessage").style.display = "none";
  const mode = document.getElementById("searchMode").value;
  updateModExplanation(mode);
  onFilterModeChange();
}

function showFilterStep() {
  const mode = document.getElementById("searchMode").value;

  if (mode === "copy") {
  const targetTopic = document.getElementById("targetTopic").value.trim();
  const targetKafka = document.getElementById("targetKafka").value.trim();

  if (!targetKafka || !targetTopic) {
    alert("Please enter both target Kafka address and target topic before continuing.");
    return;
  }
}


  document.getElementById("filterModeContainer").style.display = "block";
  onFilterModeChange();
}
function onFilterModeChange() {
  filterMode = document.querySelector('input[name="modeType"]:checked').value;


  const container = document.getElementById("dynamicFilters");
  container.innerHTML = "";
  filterIndex = 0;


  addFilter();

  const addButton = document.querySelector('button[onclick="addFilter()"]');
  if (filterMode === "pattern") {
    addButton.style.display = "none";
  } else {
    addButton.style.display = "inline-block";
  }

  document.getElementById("filtersContainer").style.display = "block";
  document.getElementById("finalSearch").style.display = "block";
}

window.onload = function () {
  document.getElementById("searchMode").addEventListener("change", function () {
  document.getElementById("rightInfoMessage").style.display = "none";
    const mode = this.value;
updateModExplanation(mode);



    document.getElementById("dateContainer").style.display = "none";
    document.getElementById("lastNContainer").style.display = "none";
    document.getElementById("manualContainer").style.display = "none";
    document.getElementById("copyContainer").style.display = "none";


    if (mode === "date") {
  document.getElementById("dateContainer").style.display = "block";
  loadOffsets("unused", "unused", null, null, "datePartitions");
}

    if (mode === "lastN") {
      document.getElementById("lastNContainer").style.display = "block";
    }

    if (mode === "manual") {
      document.getElementById("manualContainer").style.display = "block";
      loadOffsets("minOffset", "maxOffset");
    }

    if (mode === "copy") {
      document.getElementById("copyContainer").style.display = "block";
      loadOffsets("copyMinOffset", "copyMaxOffset", "copyStartOffset", "copyEndOffset");
    }

    // Buton metni ayarÄ±
    const searchButton = document.getElementById("searchButton");
    if (mode === "copy") {
      searchButton.textContent = "Copy";
    } else {
      searchButton.textContent = "Search";
    }

  });
};

function loadOffsets(minId, maxId, startInputId = null, endInputId = null, partitionElementId = null) {
  const topic = document.getElementById("topicSelect").value;
  const kafkaAddress = document.getElementById("kafkaAddress").value.trim();
  if (!topic || !kafkaAddress) return;

  fetch(`http://localhost:7070/search/topic-offsets?topic=${topic}&kafkaAddress=${encodeURIComponent(kafkaAddress)}`)
    .then(res => res.json())
    .then(data => {
      if (minId !== "unused") document.getElementById(minId).textContent = data.startOffset;
      if (maxId !== "unused") document.getElementById(maxId).textContent = data.endOffset;

      if (startInputId && endInputId) {
        document.getElementById(startInputId).value = data.startOffset;
        document.getElementById(endInputId).value = data.endOffset;
      }

      if (partitionElementId && data.partitions) {
        document.getElementById(partitionElementId).textContent = data.partitions.join(", ");
      } else if (document.getElementById("partitionList") && data.partitions) {
        document.getElementById("partitionList").textContent = data.partitions.join(", ");
      }
    })
    .catch(() => {
      if (minId !== "unused") document.getElementById(minId).textContent = "?";
      if (maxId !== "unused") document.getElementById(maxId).textContent = "?";

      if (partitionElementId) {
        document.getElementById(partitionElementId).textContent = "N/A";
      } else if (document.getElementById("partitionList")) {
        document.getElementById("partitionList").textContent = "N/A";
      }
    });
}

function generateFilters() {
  const count = parseInt(document.getElementById("filterCount").value);
  const container = document.getElementById("filtersContainer");
  container.innerHTML = "";
  if (isNaN(count) || count < 0) return alert("Invalid filter count");

  if (filterMode === "json") {
    for (let i = 0; i < count; i++) {
      const row = document.createElement("div");
      row.className = "row g-2 mb-2";
      row.innerHTML = `
        <div class="col-md-6"><input type="text" id="key_${i}" class="form-control" placeholder="Key ${i + 1}"></div>
        <div class="col-md-6"><input type="text" id="value_${i}" class="form-control" placeholder="Value ${i + 1}"></div>
      `;
      container.appendChild(row);
    }
  } else {
    for (let i = 0; i < count; i++) {
      const input = document.createElement("input");
      input.type = "text";
      input.id = `raw_${i}`;
      input.className = "form-control mb-2";
      input.placeholder = filterMode === "pattern" ? `Enter regex pattern ${i + 1}` : `Enter filter ${i + 1}`;
      container.appendChild(input);
    }
  }

  document.getElementById("filtersContainer").style.display = "block";
  document.getElementById("finalSearch").style.display = "block";
}

  function searchKafka() {
    const topic = document.getElementById("topicSelect").value;
    const kafkaAddress = document.getElementById("kafkaAddress").value.trim();
    const mode = document.getElementById("searchMode").value;
    const lastN = mode === "lastN" ? parseInt(document.getElementById("lastNCount").value || 0) : null;
    const startOffset = mode === "manual" ? parseInt(document.getElementById("startOffset").value || 0) : null;
    const endOffset = mode === "manual" ? parseInt(document.getElementById("endOffset").value || 0) : null;
    const id = `result_${++searchCount}`;

    if (mode === "manual") {
      if (isNaN(startOffset) || isNaN(endOffset) || startOffset < 0 || endOffset < startOffset) {
        return alert("LÃ¼tfen geÃ§erli bir offset aralÄ±ÄŸÄ± giriniz.");
      }
    }

    let body = { topic, mode, lastN, kafkaAddress, requestId: id };


if (mode === "manual") {
  body.startOffset = startOffset;
  body.endOffset = endOffset;
  body.filterMode = filterMode;
}

if (mode === "date") {
  const dateKey = document.getElementById("dateKey").value.trim();
  const targetDate = document.getElementById("targetDate").value.trim();
  const partition = parseInt(document.getElementById("partitionInputFirst").value);

  if (!dateKey || !targetDate || isNaN(partition)) {
    return alert("Please provide date key, date (YYYYMMDD), and partition.");
  }

  body.dateKey = dateKey;
  body.date = targetDate;
  body.partition = partition;
  body.filterMode = filterMode;
}

// Copy modu
if (mode === "copy") {
  const copyStart = parseInt(document.getElementById("copyStartOffset").value || 0);
  const copyEnd = parseInt(document.getElementById("copyEndOffset").value || 0);
  const targetKafka = document.getElementById("targetKafka").value.trim();
  const targetTopic = document.getElementById("targetTopic").value.trim();
  const partition = parseInt(document.getElementById("partitionInput").value || "0");

  if (!targetKafka) return alert("Please enter a target Kafka address.");
  if (!targetTopic) return alert("Please enter a target topic name.");
  if (isNaN(copyStart) || isNaN(copyEnd) || copyStart < 0 || copyEnd < copyStart) {
    return alert("Please enter valid offset range.");
  }

  body.startOffset = copyStart;
  body.endOffset = copyEnd;
  body.partition = partition;
  body.targetKafka = targetKafka;
  body.targetTopic = targetTopic;
  body.filterMode = filterMode;
}


    if (filterMode === "json") {
  let filters = {};
  for (let i = 0; i < filterIndex; i++) {
    const keyInput = document.getElementById(`key_${i}`);
    const valueInput = document.getElementById(`value_${i}`);
    if (keyInput && valueInput) {
      const key = keyInput.value.trim();
      const value = valueInput.value.trim();
      if (!key || !value) return alert(`Eksik filtre`);
      filters[key] = value;
    }
  }
  body.filters = filters;
} else {
  const rawFilters = [];
  for (let i = 0; i < filterIndex; i++) {
    const input = document.getElementById(`raw_${i}`);
    if (input) {
      const value = input.value.trim();
      if (!value) return alert(`Eksik string filtre`);
      rawFilters.push(value);
    }
  }
  body.rawFilters = rawFilters;
}


    const controller = new AbortController();
    abortControllers[id] = controller;


    const tab = document.createElement("div");
    tab.className = "result-tab";
    tab.id = id + "_tab";
    tab.innerHTML = `
      Result ${searchCount}
      <span class="spinner-border spinner-border-sm" role="status"></span>
      <span class="close-x" onclick="event.stopPropagation(); killResult('${id}')">&times;</span>
    `;
    tab.onclick = () => toggleResult(id);
    document.getElementById("resultTabs").appendChild(tab);

    const box = document.createElement("div");
    box.className = "result-box";
    box.id = id + "_box";
    box.style.display = "none";
    document.getElementById("resultBoxes").appendChild(box);

let url;
if (filterMode === "json") {
  url = "http://localhost:7070/search";
} else if (filterMode === "pattern") {
  url = "http://localhost:7070/search/pattern-search";
} else {
  url = "http://localhost:7070/search/simple-string-search";
}

    fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
      signal: controller.signal
    })
    .then(res => res.json())
    .then(data => {
      // Spinner kaldÄ±r
      const spinner = tab.querySelector(".spinner-border");
      if (spinner) spinner.remove();

      box.innerHTML = "";

const summary = document.createElement("div");
summary.className = "filter-summary";
summary.innerHTML = `
  <div><strong>Filter Type:</strong> ${filterMode === "json" ? "JSON" : "String"}</div>
  <div><strong>Filters:</strong> ${
    filterMode === "json"
      ? Object.entries(body.filters).map(([k, v]) => `${k}=${v}`).join(", ")
      : body.rawFilters.join(", ")
  }</div>
  <div><strong>Mode:</strong> ${mode}${mode === "lastN" ? ` (${lastN})` : ""}${mode === "manual" ? ` (Offsets: ${startOffset} - ${endOffset})` : ""}</div>
  <hr style="margin: 0.4rem 0;" />
`;

summary.style.position = "relative";


const reverseBtn = document.createElement("button");
reverseBtn.className = "btn btn-sm btn-outline-secondary me-2";
reverseBtn.style.position = "absolute";
reverseBtn.style.bottom = "2rem";
reverseBtn.style.right = "0.4rem";
reverseBtn.textContent = "â†• Reverse";
reverseBtn.title = "Reverse result order";
reverseBtn.onclick = () => {
  const entries = Array.from(box.querySelectorAll(".record-entry"));
  entries.reverse().forEach(entry => box.appendChild(entry));
};
summary.appendChild(reverseBtn);


const downloadBtn = document.createElement("button");
downloadBtn.className = "btn btn-sm btn-outline-primary";
downloadBtn.style.position = "absolute";
downloadBtn.style.top = "-5rem";
downloadBtn.style.right = "0.5rem";
downloadBtn.title = "Download results";
downloadBtn.innerHTML = "â¬‡ Download";

downloadBtn.onclick = () => {
  let headerLines = [];
  headerLines.push(`Filter Type: ${filterMode === "json" ? "JSON" : "String"}`);

  if (filterMode === "json") {
    headerLines.push("Filters: " + Object.entries(body.filters).map(([k,v]) => `${k}=${v}`).join(", "));
  } else {
    headerLines.push("Filters: " + body.rawFilters.join(", "));
  }

  headerLines.push(`Mode: ${mode}${mode === "lastN" ? ` (${lastN})` : ""}${mode === "manual" ? ` (Offsets: ${startOffset} - ${endOffset})` : ""}`);

  const resultsText = Array.from(box.querySelectorAll(".record-entry"))
    .map(div => div.textContent)
    .join("\n\n");

  const textContent = headerLines.join("\n") + "\n\n" + resultsText;

  const blob = new Blob([textContent], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = id + ".txt";
  a.click();
  URL.revokeObjectURL(url);
};

summary.appendChild(downloadBtn);
box.appendChild(summary);

      if (!data || data.length === 0) {
        box.innerHTML += "<em>No matching results.</em>";
        return;
      }

      data.forEach(record => {
        const div = document.createElement("div");
        div.className = "record-entry";
        try {
          const parsed = JSON.parse(record);
          div.innerHTML = `<strong>Offset:</strong> ${parsed.offset}<br><pre>${JSON.stringify(parsed.value, null, 2)}</pre>`;
        } catch {
          div.textContent = record;
        }
        box.appendChild(div);
      });
    })
    .catch(err => {
      if (err.name === "AbortError") return;
      alert("Kafka sorgusu sÄ±rasÄ±nda hata oluÅŸtu.");
    });
  }

  function toggleResult(id) {
    const allTabs = document.querySelectorAll(".result-tab");
    const allBoxes = document.querySelectorAll(".result-box");
    allTabs.forEach(tab => tab.classList.remove("active"));
    allBoxes.forEach(box => (box.style.display = "none"));

    const tab = document.getElementById(id + "_tab");
    const box = document.getElementById(id + "_box");
    if (activeTabId === id) {
      activeTabId = null;
    } else {
      tab.classList.add("active");
      box.style.display = "block";
      activeTabId = id;
    }
  }

  function killResult(id) {
    const tab = document.getElementById(id + "_tab");
    const box = document.getElementById(id + "_box");
    if (tab) tab.remove();
    if (box) box.remove();
    if (activeTabId === id) activeTabId = null;

    if (abortControllers[id]) {
      abortControllers[id].abort();
      delete abortControllers[id];
    }

    fetch("http://localhost:7070/search/cancel", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ requestId: id })
    });
  }

  let filterIndex = 0;

function addFilter(key = "", value = "") {
  filterMode = document.querySelector('input[name="modeType"]:checked').value;

  const container = document.getElementById("dynamicFilters");


  if (filterMode === "pattern") {
    const existing = document.querySelectorAll(`#dynamicFilters input[id^="raw_"]`);
    if (existing.length >= 1) return;
  }

  const row = document.createElement("div");
  row.className = "row g-2 mb-2 align-items-center";
  row.id = `filterRow_${filterIndex}`;

  if (filterMode === "json") {
    row.innerHTML = `
      <div class="col-md-5">
        <input type="text" class="form-control" id="key_${filterIndex}" placeholder="Key" value="${key}">
      </div>
      <div class="col-md-5">
        <input type="text" class="form-control" id="value_${filterIndex}" placeholder="Value" value="${value}">
      </div>
      <div class="col-md-2 text-end">
        <button class="btn btn-sm btn-outline-danger" onclick="removeFilter(${filterIndex})">âˆ’</button>
      </div>
    `;
  } else {
    row.innerHTML = `
      <div class="col-md-10">
        <input type="text" class="form-control" id="raw_${filterIndex}" placeholder="${filterMode === 'pattern' ? 'Regex pattern' : 'String filter'}" value="${key}">
      </div>
      <div class="col-md-2 text-end">
        <button class="btn btn-sm btn-outline-danger" onclick="removeFilter(${filterIndex})">âˆ’</button>
      </div>
    `;
  }

  container.appendChild(row);
  filterIndex++;


  if (filterMode === "pattern") {
    document.querySelector('button[onclick="addFilter()"]').style.display = "none";
  }
}


function removeFilter(index) {
  const row = document.getElementById(`filterRow_${index}`);
  if (row) {
    row.remove();


    if (filterMode === "pattern") {
      document.querySelector('button[onclick="addFilter()"]').style.display = "inline-block";
    }

    filterIndex--;
  }
}
function updateModExplanation(mode) {
  const explanationBox = document.getElementById("modExplanation");
  const explanationText = document.getElementById("modExplanationText");

  if (modeExplanations[mode]) {
    explanationBox.style.display = "block";
    explanationText.textContent = modeExplanations[mode];
  } else {
    explanationBox.style.display = "none";
  }
}

let allTopics = []; // autocomplete iÃ§in global

function filterTopics() {
  const input = document.getElementById("topicSelect").value.trim().toLowerCase();
  const box = document.getElementById("autocompleteBox");
  box.innerHTML = "";

  if (!input) {
  allTopics.forEach(topic => {
    const div = document.createElement("div");
    div.textContent = topic;
    div.onclick = () => {
      document.getElementById("topicSelect").value = topic;
      box.innerHTML = "";
      topicSelected();
    };
    box.appendChild(div);
  });
  return;
}

  const matches = allTopics.filter(topic => topic.toLowerCase().includes(input));
  matches.forEach(topic => {
    const div = document.createElement("div");
    div.textContent = topic;
    div.onclick = () => {
      document.getElementById("topicSelect").value = topic;
      box.innerHTML = "";
      topicSelected(); // senin mevcut fonksiyonun
    };
    box.appendChild(div);
  });
}

// Otomatik kapansÄ±n: dÄ±ÅŸa tÄ±klama
document.addEventListener("click", function (e) {
  if (!e.target.closest("#topicSelect") && !e.target.closest("#autocompleteBox")) {
    document.getElementById("autocompleteBox").innerHTML = "";
  }
});

function showAllTopics() {
  const box = document.getElementById("autocompleteBox");
  box.innerHTML = "";

  allTopics.forEach(topic => {
    const div = document.createElement("div");
    div.textContent = topic;
    div.onclick = () => {
      document.getElementById("topicSelect").value = topic;
      box.innerHTML = "";
      topicSelected();
    };
    box.appendChild(div);
  });
}

</script>

</body>
</html>
