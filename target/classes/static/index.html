<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Kafka Search UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      body {
        background-color: #f8f9fa;
        padding: 2rem;
      }
      .section {
        margin-bottom: 2rem;
        padding: 2rem;
        border-radius: 8px;
        background: white;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
      }
      .result-box {
        background-color: #f1f1f1;
        border: 1px solid #ccc;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 6px;
        font-family: monospace;
        white-space: pre-wrap;
        word-break: break-word;
      }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mb-4">ðŸ”Ž Kafka Search</h1>

    <!-- STEP 1 -->
    <div class="section">
        <label for="topicSelect" class="form-label">Kafka Topic</label>
        <select id="topicSelect" class="form-select">
            <option disabled selected value="">Loading topics...</option>
        </select>
        <button onclick="nextStep()" class="btn btn-primary mt-3">Next</button>
    </div>

    <!-- STEP 2 -->
    <div class="section" id="filterStep" style="display: none;">
        <label for="filterCount" class="form-label">How many filters?</label>
        <input type="number" id="filterCount" class="form-control" min="0" />
        <button onclick="generateFilters()" class="btn btn-primary mt-3">Continue</button>
    </div>

    <!-- STEP 3 -->
    <div class="section" id="filtersContainer"></div>

    <!-- Search Options -->
    <div class="section" id="searchOptions" style="display: none;">
        <label for="searchMode" class="form-label">Search Mode</label>
        <select id="searchMode" class="form-select">
            <option value="all">All</option>
            <option value="last">Last</option>
            <option value="lastN">LastN</option>
        </select>

        <div id="lastNContainer" class="mt-2" style="display: none;">
            <label for="lastNCount" class="form-label">KaÃ§ kayÄ±t geriye gidilsin? (Ã¶rn: 1000000)</label>
            <input type="number" id="lastNCount" class="form-control" min="1" />
        </div>
    </div>

    <!-- FINAL STEP -->
    <div id="finalSearch" class="mb-3" style="display: none;">
        <button onclick="searchKafka()" class="btn btn-success">Search Kafka</button>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" style="display: none;" class="mt-3 text-primary">
        <div class="spinner-border spinner-border-sm" role="status"></div>
        <span>Loading...</span>
    </div>

    <!-- Results -->
    <div class="section">
        <h5>Results:</h5>
        <div id="resultContainer"></div>
    </div>
</div>

<script>
  window.onload = function () {
    fetch("http://localhost:7070/search/topics")
      .then(res => res.json())
      .then(data => {
        const select = document.getElementById("topicSelect");
        select.innerHTML = '<option disabled selected value="">Select a topic</option>';
        data.forEach(topic => {
          const option = document.createElement("option");
          option.value = topic;
          option.textContent = topic;
          select.appendChild(option);
        });
      })
      .catch(err => {
        console.error("Topic listesi alÄ±namadÄ±:", err);
        alert("Kafka topic listesi yÃ¼klenemedi.");
      });

    // Event listener: Search Mode seÃ§imi deÄŸiÅŸirse
    document.getElementById("searchMode").addEventListener("change", function () {
      const lastNContainer = document.getElementById("lastNContainer");
      lastNContainer.style.display = this.value === "lastN" ? "block" : "none";
    });
  }

  function nextStep() {
    const topic = document.getElementById("topicSelect").value;
    if (!topic) {
      alert("Please select a topic.");
      return;
    }

    // DoÄŸrudan filtre adÄ±mÄ±na geÃ§
    document.getElementById("filterStep").style.display = "block";
  }

  function generateFilters() {
    const count = parseInt(document.getElementById("filterCount").value);
    const container = document.getElementById("filtersContainer");
    container.innerHTML = "";

    if (isNaN(count) || count < 0) {
      alert("Invalid filter count");
      return;
    }

    for (let i = 0; i < count; i++) {
      const row = document.createElement("div");
      row.className = "row g-2 mb-2";
      row.innerHTML = `
        <div class="col-md-6">
          <input type="text" id="key_${i}" class="form-control" placeholder="Key ${i + 1}">
        </div>
        <div class="col-md-6">
          <input type="text" id="value_${i}" class="form-control" placeholder="Value ${i + 1}">
        </div>
      `;
      container.appendChild(row);
    }

    document.getElementById("finalSearch").style.display = "block";
    document.getElementById("searchOptions").style.display = "block";
  }

  function searchKafka() {
    const topic = document.getElementById("topicSelect").value;
    const count = parseInt(document.getElementById("filterCount").value);
    const filters = {};

    for (let i = 0; i < count; i++) {
      const key = document.getElementById(`key_${i}`).value.trim();
      const value = document.getElementById(`value_${i}`).value.trim();

      if (!key || !value) {
        alert(`LÃ¼tfen tÃ¼m filtre alanlarÄ±nÄ± doldurun (Eksik filtre ${i + 1}).`);
        return;
      }

      filters[key] = value;
    }

    const mode = document.getElementById("searchMode").value;
    const lastNInput = document.getElementById("lastNCount").value;
    const lastN = mode === "lastN" && lastNInput ? parseInt(lastNInput) : null;

    const searchBtn = document.querySelector('#finalSearch button');
    const loading = document.getElementById("loading");
    const resultContainer = document.getElementById("resultContainer");

    searchBtn.disabled = true;
    searchBtn.innerText = "Searching...";
    loading.style.display = "block";
    resultContainer.innerHTML = "";

    fetch("http://localhost:7070/search", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ topic, filters, mode, lastN })
    })
      .then(res => res.json())
      .then(data => {
        if (Array.isArray(data)) {

          data.forEach(record => {
            const div = document.createElement("div");
            div.className = "result-box";

            try {
              const parsed = JSON.parse(record);
              const offset = parsed.offset;
              const value = parsed.value;

              div.innerHTML = `<strong>Offset:</strong> ${offset}<br><pre>${JSON.stringify(value, null, 2)}</pre>`;
            } catch (e) {
              div.textContent = record;
            }

            resultContainer.appendChild(div);
          });
        } else {
          resultContainer.textContent = "Beklenmeyen veri yapÄ±sÄ± alÄ±ndÄ±.";
        }
      })
      .catch(err => {
        console.error(err);
        alert("Kafka sorgusu sÄ±rasÄ±nda hata oluÅŸtu.");
      })
      .finally(() => {
        loading.style.display = "none";
        searchBtn.disabled = false;
        searchBtn.innerText = "Search Kafka";
      });
  }
</script>
</body>
</html>