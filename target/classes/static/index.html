<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Kafka Search UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
    body {
      background-color: #f8f9fa;
      padding: 2rem;
    }
    .section {
      margin-bottom: 2rem;
      padding: 2rem;
      border-radius: 8px;
      background: white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
    }
    .close-x {
      position: absolute;
      top: 2px;
      right: 6px;
      font-size: 14px;
      color: #666;
      cursor: pointer;
      line-height: 1;
      padding: 0;
    }
    .close-x:hover {
      color: #c00;
    }
    .record-entry {
      background-color: #ffffff;
      border: 1px solid #aaa;
      padding: 1rem;
      margin-top: 0.5rem;
      border-radius: 4px;
    }
    .filter-summary {
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 0.2rem;
      line-height: 1.2;
    }
    .result-tab {
      display: inline-block;
      margin-right: 1rem;
      padding: 0.5rem 1rem;
      background-color: #e2e6ea;
      border-radius: 5px;
      cursor: pointer;
      position: relative;
      user-select: none;
    }
    .result-tab.active {
      background-color: #cce5ff;
    }
    .result-box {
      background-color: #f1f1f1;
      border: 1px solid #ccc;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 6px;
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .spinner-border-sm {
      position: absolute;
      right: 8px;
      top: 8px;
    }
  </style>
</head>
<body>
<div class="container">
    <h1 class="mb-4">ðŸ”Ž K-Search</h1>

    <div class="section">
        <label for="kafkaAddress" class="form-label">Kafka Address (IP:PORT)</label>
        <input type="text" id="kafkaAddress" class="form-control" placeholder="e.g., 127.0.0.1:9092" />
        <button onclick="loadTopics()" class="btn btn-primary mt-2">Load Topics</button>
    </div>

    <div class="section" id="topicSection" style="display: none;">
        <label for="topicSelect" class="form-label">Kafka Topic</label>
        <select id="topicSelect" class="form-select">
            <option disabled selected value="">Select a topic</option>
        </select>
        <button onclick="nextStep()" class="btn btn-primary mt-3">Next</button>
    </div>

    <div class="mt-3">
        <label>Filter Mode:</label>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="modeType" id="stringMode" value="string" checked onchange="onFilterModeChange()" />
            <label class="form-check-label" for="stringMode">String</label>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="modeType" id="jsonMode" value="json" onchange="onFilterModeChange()" />
            <label class="form-check-label" for="jsonMode">JSON</label>
        </div>
    </div>

    <div class="section" id="filterStep" style="display: none;">
        <label for="filterCount" class="form-label">How many filters?</label>
        <input type="number" id="filterCount" class="form-control" min="0" value="0" />
        <button onclick="generateFilters()" class="btn btn-primary mt-3">Continue</button>
    </div>

    <div class="section" id="filtersContainer"></div>

    <div class="section" id="searchOptions" style="display: none;">
        <label for="searchMode" class="form-label">Search Mode</label>
        <select id="searchMode" class="form-select">
            <option value="all">All</option>
            <option value="last">Last</option>
            <option value="lastN">LastN</option>
            <option value="offsetRange">Manuel</option>
        </select>
        <div id="lastNContainer" class="mt-2" style="display: none;">
            <label for="lastNCount" class="form-label">KaÃ§ kayÄ±t geriye gidilsin? (Ã¶rn: 1000000)</label>
            <input type="number" id="lastNCount" class="form-control" min="1" />
        </div>
        <div id="offsetRangeContainer" class="mt-2" style="display: none;">
            <div><strong>Topic Offset Range:</strong> Min: <span id="minOffset">?</span>, Max: <span id="maxOffset">?</span></div>
            <label for="startOffset" class="form-label mt-2">Start Offset</label>
            <input type="number" id="startOffset" class="form-control" />
            <label for="endOffset" class="form-label mt-2">End Offset</label>
            <input type="number" id="endOffset" class="form-control" />
        </div>
    </div>

    <div id="finalSearch" class="mb-3" style="display: none;">
        <button onclick="searchKafka()" class="btn btn-success">Search Kafka</button>
    </div>

    <div class="section">
        <h5>Results:</h5>
        <div id="resultTabs"></div>
        <div id="resultBoxes"></div>
    </div>
</div>

<script>
  let searchCount = 0;
  let activeTabId = null;
  const abortControllers = {};
  let filterMode = "string";

  window.onload = function () {
    document.getElementById("searchMode").addEventListener("change", function () {
      const mode = this.value;
      document.getElementById("lastNContainer").style.display = mode === "lastN" ? "block" : "none";
      document.getElementById("offsetRangeContainer").style.display = mode === "offsetRange" ? "block" : "none";

      if (mode === "offsetRange") {
        const topic = document.getElementById("topicSelect").value;
        const kafkaAddress = document.getElementById("kafkaAddress").value.trim();
        if (!topic || !kafkaAddress) return;

        fetch(`http://localhost:7070/search/topic-offsets?topic=${topic}&kafkaAddress=${encodeURIComponent(kafkaAddress)}`)
          .then(res => res.json())
          .then(data => {
            document.getElementById("minOffset").textContent = data.startOffset;
            document.getElementById("maxOffset").textContent = data.endOffset;
          })
          .catch(() => {
            document.getElementById("minOffset").textContent = "?";
            document.getElementById("maxOffset").textContent = "?";
          });
      }
    });
  };

  function loadTopics() {
    const kafkaAddress = document.getElementById("kafkaAddress").value.trim();
    if (!kafkaAddress) return alert("Kafka address is required");

    fetch(`http://localhost:7070/search/topics?kafkaAddress=${encodeURIComponent(kafkaAddress)}`)
      .then(res => res.json())
      .then(data => {
        const select = document.getElementById("topicSelect");
        select.innerHTML = '<option disabled selected value="">Select a topic</option>';
        data.forEach(topic => {
          const option = document.createElement("option");
          option.value = topic;
          option.textContent = topic;
          select.appendChild(option);
        });
        document.getElementById("topicSection").style.display = "block";
      })
      .catch(err => {
        console.error(err);
        alert("Failed to load topics.");
      });
  }

  function nextStep() {
    if (!document.getElementById("topicSelect").value) return alert("Please select a topic.");
    document.getElementById("filterStep").style.display = "block";
  }

  function onFilterModeChange() {
    filterMode = document.querySelector('input[name="modeType"]:checked').value;
    document.getElementById("filtersContainer").innerHTML = "";
    document.getElementById("filterCount").value = 0;
    document.getElementById("finalSearch").style.display = "none";
    document.getElementById("searchOptions").style.display = "none";
  }

  function generateFilters() {
    const count = parseInt(document.getElementById("filterCount").value);
    const container = document.getElementById("filtersContainer");
    container.innerHTML = "";
    if (isNaN(count) || count < 0) return alert("Invalid filter count");

    if (filterMode === "json") {
      for (let i = 0; i < count; i++) {
        const row = document.createElement("div");
        row.className = "row g-2 mb-2";
        row.innerHTML = `
          <div class="col-md-6"><input type="text" id="key_${i}" class="form-control" placeholder="Key ${i + 1}"></div>
          <div class="col-md-6"><input type="text" id="value_${i}" class="form-control" placeholder="Value ${i + 1}"></div>
        `;
        container.appendChild(row);
      }
    } else {
      for (let i = 0; i < count; i++) {
        const input = document.createElement("input");
        input.type = "text";
        input.id = `raw_${i}`;
        input.className = "form-control mb-2";
        input.placeholder = `Enter filter ${i + 1}`;
        container.appendChild(input);
      }
    }

    document.getElementById("finalSearch").style.display = "block";
    document.getElementById("searchOptions").style.display = "block";
  }

  function searchKafka() {
    const topic = document.getElementById("topicSelect").value;
    const kafkaAddress = document.getElementById("kafkaAddress").value.trim();
    const count = parseInt(document.getElementById("filterCount").value);
    const mode = document.getElementById("searchMode").value;
    const lastN = mode === "lastN" ? parseInt(document.getElementById("lastNCount").value || 0) : null;
    const startOffset = mode === "offsetRange" ? parseInt(document.getElementById("startOffset").value || 0) : null;
    const endOffset = mode === "offsetRange" ? parseInt(document.getElementById("endOffset").value || 0) : null;
    const id = `result_${++searchCount}`;

    if (mode === "offsetRange") {
      if (isNaN(startOffset) || isNaN(endOffset) || startOffset < 0 || endOffset < startOffset) {
        return alert("LÃ¼tfen geÃ§erli bir offset aralÄ±ÄŸÄ± giriniz.");
      }
    }

    let body = { topic, mode, lastN, kafkaAddress, requestId: id };
    if (mode === "offsetRange") {
      body.startOffset = startOffset;
      body.endOffset = endOffset;
    }

    if (filterMode === "json") {
      let filters = {};
      for (let i = 0; i < count; i++) {
        const key = document.getElementById(`key_${i}`).value.trim();
        const value = document.getElementById(`value_${i}`).value.trim();
        if (!key || !value) return alert(`Eksik filtre ${i + 1}`);
        filters[key] = value;
      }
      body.filters = filters;
    } else {
      const rawFilters = [];
      for (let i = 0; i < count; i++) {
        const raw = document.getElementById(`raw_${i}`).value.trim();
        if (!raw) return alert(`Eksik string filtre ${i + 1}`);
        rawFilters.push(raw);
      }
      body.rawFilters = rawFilters;
    }

    // Yeni AbortController oluÅŸtur
    const controller = new AbortController();
    abortControllers[id] = controller;

    // Yeni tab ve result box oluÅŸtur
    const tab = document.createElement("div");
    tab.className = "result-tab";
    tab.id = id + "_tab";
    tab.innerHTML = `
      Result ${searchCount}
      <span class="spinner-border spinner-border-sm" role="status"></span>
      <span class="close-x" onclick="event.stopPropagation(); killResult('${id}')">&times;</span>
    `;
    tab.onclick = () => toggleResult(id);
    document.getElementById("resultTabs").appendChild(tab);

    const box = document.createElement("div");
    box.className = "result-box";
    box.id = id + "_box";
    box.style.display = "none";
    document.getElementById("resultBoxes").appendChild(box);

    const url = filterMode === "json" ? "http://localhost:7070/search" : "http://localhost:7070/search/simple-string-search";

    fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
      signal: controller.signal
    })
    .then(res => res.json())
    .then(data => {
      // Spinner kaldÄ±r
      const spinner = tab.querySelector(".spinner-border");
      if (spinner) spinner.remove();

      box.innerHTML = "";

      const summary = document.createElement("div");
      summary.className = "filter-summary";
      summary.innerHTML = `
        <div><strong>Filter Type:</strong> ${filterMode === "json" ? "JSON" : "String"}</div>
        <div><strong>Filters:</strong> ${
          filterMode === "json"
            ? Object.entries(body.filters).map(([k, v]) => `${k}=${v}`).join(", ")
            : body.rawFilters.join(", ")
        }</div>
        <div><strong>Mode:</strong> ${mode}${mode === "lastN" ? ` (${lastN})` : ""}${mode === "offsetRange" ? ` (Offsets: ${startOffset} - ${endOffset})` : ""}</div>
        <hr style="margin: 0.4rem 0;" />
      `;
      box.appendChild(summary);

      summary.style.position = "relative";

const downloadBtn = document.createElement("button");
downloadBtn.className = "btn btn-sm btn-outline-primary";
downloadBtn.style.position = "absolute";
downloadBtn.style.top = "0.2rem";
downloadBtn.style.right = "0.5rem";
downloadBtn.title = "Download results";
downloadBtn.innerHTML = "â¬‡ Download";

downloadBtn.onclick = () => {
  let headerLines = [];
  headerLines.push(`Filter Type: ${filterMode === "json" ? "JSON" : "String"}`);

  if (filterMode === "json") {
    headerLines.push("Filters: " + Object.entries(body.filters).map(([k,v]) => `${k}=${v}`).join(", "));
  } else {
    headerLines.push("Filters: " + body.rawFilters.join(", "));
  }

  headerLines.push(`Mode: ${mode}${mode === "lastN" ? ` (${lastN})` : ""}${mode === "offsetRange" ? ` (Offsets: ${startOffset} - ${endOffset})` : ""}`);

  const resultsText = Array.from(box.querySelectorAll(".record-entry"))
    .map(div => div.textContent)
    .join("\n\n");

  const textContent = headerLines.join("\n") + "\n\n" + resultsText;

  const blob = new Blob([textContent], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = id + ".txt";
  a.click();
  URL.revokeObjectURL(url);
};

summary.appendChild(downloadBtn);

      if (!data || data.length === 0) {
        box.innerHTML += "<em>No matching results.</em>";
        return;
      }

      data.forEach(record => {
        const div = document.createElement("div");
        div.className = "record-entry";
        try {
          const parsed = JSON.parse(record);
          div.innerHTML = `<strong>Offset:</strong> ${parsed.offset}<br><pre>${JSON.stringify(parsed.value, null, 2)}</pre>`;
        } catch {
          div.textContent = record;
        }
        box.appendChild(div);
      });
    })
    .catch(err => {
      if (err.name === "AbortError") return;
      alert("Kafka sorgusu sÄ±rasÄ±nda hata oluÅŸtu.");
    });
  }

  function toggleResult(id) {
    const allTabs = document.querySelectorAll(".result-tab");
    const allBoxes = document.querySelectorAll(".result-box");
    allTabs.forEach(tab => tab.classList.remove("active"));
    allBoxes.forEach(box => (box.style.display = "none"));

    const tab = document.getElementById(id + "_tab");
    const box = document.getElementById(id + "_box");
    if (activeTabId === id) {
      activeTabId = null;
    } else {
      tab.classList.add("active");
      box.style.display = "block";
      activeTabId = id;
    }
  }

  function killResult(id) {
    const tab = document.getElementById(id + "_tab");
    const box = document.getElementById(id + "_box");
    if (tab) tab.remove();
    if (box) box.remove();
    if (activeTabId === id) activeTabId = null;

    if (abortControllers[id]) {
      abortControllers[id].abort();
      delete abortControllers[id];
    }

    fetch("http://localhost:7070/search/cancel", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ requestId: id })
    });
  }
</script>

</body>
</html>
